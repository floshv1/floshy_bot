name: Deploy to Raspberry Pi

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - 'Dockerfile'
      - 'docker-compose.yml'
  workflow_dispatch:  # Permet un d√©ploiement manuel

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Deploy to Raspberry Pi
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.RPI_HOST }}
        username: ${{ secrets.RPI_USER }}
        key: ${{ secrets.RPI_SSH_KEY }}
        script: |
          set -e
          
          echo "üöÄ D√©ploiement en cours..."
          
          BOT_DIR="/home/${{ secrets.RPI_USER }}/floshy_bot"
          
          # Aller dans le r√©pertoire
          cd $BOT_DIR
          
          # Pull les changements
          echo "üì• Mise √† jour du code..."
          git pull origin main
          
          # Rebuild et red√©marrer
          echo "üê≥ Reconstruction Docker..."
          docker compose down
          docker compose build --no-cache
          
          echo "‚úÖ D√©marrage du bot..."
          docker compose up -d
          
          # V√©rify
          sleep 2
          echo "üìä Status:"
          docker compose ps
          
          echo "‚ú® D√©ploiement termin√©!"
          
          # Affiche les 10 derni√®res lignes de logs
          echo "üìù Derniers logs:"
          docker compose logs --tail=10 bot

